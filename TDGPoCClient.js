var TDGPoCClient=function(e){"use strict";function U(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var j=U(mqtt);const i=["none","error","warn","info","verb","debug"].reduce((e,t,s)=>(e[t]=s,e),{});let r="debug";const t=(e,t,...s)=>{i[e]>i[r]||t(`${(new Date).toISOString()} - ${e.toUpperCase().padEnd(5," ")}:`,...s)},v={debug:(...e)=>t("debug",console.debug,...e),verbose:(...e)=>t("verb",console.debug,...e),info:(...e)=>t("info",console.info,...e),warn:(...e)=>t("warn",console.warn,...e),error:(...e)=>t("error",console.error,...e),setLevel:(e="")=>("warning"===(e="verbose"===(e=e.toLowerCase())?"verb":e)&&(e="warn"),r="number"==typeof i[e]?e:r)},s=(t=12)=>{var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let i="";for(let e=0;e<t;e++){var r=Math.floor(Math.random()*s.length);i+=s.substring(r,r+1)}return i},n=t=>new Promise(e=>{setTimeout(e,t)}),a=(e,t)=>{try{var s=new URL(e).protocol.slice(0,-1);return t.includes(s)}catch(e){v.debug(e)}return!1},o=()=>null!==window.navigator.userAgent.match("Firefox"),h=()=>null!==window.navigator.userAgent.match("Chrome"),c=(()=>{let t,s=Math.floor(Number.MAX_SAFE_INTEGER*Math.random());return e=>(t=s,(s+=1)>=Number.MAX_SAFE_INTEGER&&(s=0),""+t)})();class q{constructor(e){this.listener={},this.type=""|e}on(e,t){return this.listener[e]||(this.listener[e]=[]),this.listener[e].push(t),!0}off(e,t){return!!this.listener[e]&&(-1<(t=this.listener[e].indexOf(t))&&this.listener[e].splice(t,1),!0)}offAll(){this.listener={}}dispatch(e,t){return!!this.listener[e]&&(this.listener[e].map(e=>{e.apply(null,[t])}),!0)}}const d="[trans_handler]";class M{constructor(e=c()){this.id=e,this._transactions=new Map,v.verbose(d+` [${this.id}] creating new transaction handler`)}clear(){v.verbose(d+` [${this.id}] clearing transaction handler`),this._transactions.clear()}has(e){return!!e&&this._transactions.has(e)}get(e){return e&&this.has(e)?this._transactions.get(e):null}size(){return this._transactions.size}set(e,t){e&&t&&this._transactions.set(e,t)}delete(e){e&&this.has(e)&&this._transactions.delete(e)}getTransactionOwner(e){if(e&&this.has(e))return this.get(e).owner}createTransaction(e,t,s,i,r){if(!this.has(e))return this.set(e,t={id:e,owner:t,request:s,done:i,error:r}),v.verbose(d+` ${t.owner.name} created new transaction ${e}, request "${t.request}"`),t}closeTransactionWithError(e,t,s){var i=this.get(e);if(i&&i.owner===t)return this.delete(e),i.error(s),v.verbose(d+` [${i.owner.id}] closed with error transaction ${e}, request "${i.request}"`),i}closeAllTransactionsWithError(e,t){for(var[s,i]of this._transactions)e&&i.owner!==e||this.closeTransactionWithError(i.id,i.owner,t)}closeTransactionWithSuccess(e,t,s){var i=this.get(e);if(i&&i.owner===t)return this.delete(e),i.done(s),v.verbose(d+` [${i.owner.id}] closed with success transaction ${e}, request "${i.request}"`),i}}const _={REQUEST:{SERVER_INFO:"info",CREATE_SESSION:"create",KEEPALIVE:"keepalive",DESTROY_SESSION:"destroy",ATTACH_PLUGIN:"attach",MESSAGE:"message",TRICKLE:"trickle",HANGUP:"hangup",DETACH_PLUGIN:"detach"},ACK:"ack",RESPONSE:{SUCCESS:"success",SERVER_INFO:"server_info",ERROR:"error"},EVENT:{EVENT:"event",DETACHED:"detached",HANGUP:"hangup",MEDIA:"media",TIMEOUT:"timeout",WEBRTCUP:"webrtcup",SLOWLINK:"slowlink",TRICKLE:"trickle"},ADMIN:{LIST_SESSIONS:"list_sessions",LIST_HANDLES:"list_handles",HANDLE_INFO:"handle_info",START_PCAP:"start_pcap",STOP_PCAP:"stop_pcap"}},l=e=>!("object"!=typeof e||!e)&&Object.values(_.RESPONSE).includes(e.janus),u=e=>!("object"!=typeof e||!e)&&e.janus===_.RESPONSE.ERROR,m={CREATING:"creating",CREATED:"created",DESTROYING:"destroying",DESTROYED:"destroyed"},E={PUB:"publisher",SUB:"subscriber",PUB_SUB:"pub_sub"},p={ATTACHING:"attaching",ATTACHED:"attached",DETACHING:"detaching",DETACHED:"detached"},f={NEW:"new",CONNECTING:"connecting",CONNECTED:"connected",DISCONNECTING:"disconnecting",DISCONNECTED:"disconnected"},g={NEW:"new",EXIST_CHECKING:"exist_checking",CREATING:"creating",EXISTED:"existed",JOINING:"joining",JOINED:"joined",LEAVING:"leaving",LEFT:"left",REJECTED:"rejected",KICKED:"kicked",LOCKED:"locked",PAUSED:"paused"},w={WEBRTC_NOT_SUPPORTED:"webrtc_not_supported",WEBRTC_CAPTURE_FAILED:"webrtc_capture_failed",SESSION_STATE_CHANGED:"session_state_changed",ROOM_STATE_CHANGED:"room_state_changed",WEBRTC_UP:"webrtc_up",WEBRTC_DOWN:"webrtc_down",MEDIA_LOCAL_STREAM:"media_local_stream",MEDIA_REMOTE_STREAM:"media_remote_stream",MEDIA_STATE_CHANGED:"media_state_changed",MEDIA_REMOTE_FEEDS_ADDED:"media_remote_feeds_added",PEER_JOINED:"peer_joined",PEER_LEFT:"peer_left"},b="[handle]";class B extends q{constructor(e,t){super("handle"),this._session=e,this._trans_handler=e._trans_handler,this._state=p.ATTACHED,this.id=t,this.name=`[${this.id}]`}async detach(){if(this._state!==p.ATTACHED)throw e=new Error(`detach handle invalid state "${this._state}"`),v.verbose(b+` ${this.name} `+e.message),e;v.info(b+` ${this.name} detaching handle`),this._state=p.DETACHING;var e={janus:_.REQUEST.DETACH_PLUGIN};try{return this.sendRequest(e)}catch(e){throw v.error(b+` ${this.name} error while detaching (${e.message})`),e}}async hangup(){if(this._pc_state!==f.CONNECTED)throw e=new Error(`hangup handle invalid state "${this._state}"`),v.verbose(b+` ${this.name} `+e.message),e;v.info(b+` ${this.name} hangup-ing handle`),this._pc_state=f.DISCONNECTING;var e={janus:_.REQUEST.HANGUP};try{return this.sendRequest(e)}catch(e){throw v.error(b+` ${this.name} error while hanging up (${e.message})`),e}}async trickle(e){if(!e)return this.trickleComplete();if("object"!=typeof e)throw t=new Error("invalid candidate object"),v.error(b+` ${this.name} `+t.message),t;var t={janus:_.REQUEST.TRICKLE};Array.isArray(e)?t.candidates=e:t.candidate=e;try{return this.sendRequest(t)}catch(e){throw v.error(b+` ${this.name} error on trickle (${e.message})`),e}}async trickleComplete(){return this.trickle({completed:!0})}_handleMessage(t){var e,{transaction:s,janus:i}=t;if(this._trans_handler.getTransactionOwner(s)===this){if("object"==typeof(e=t)&&e&&e.janus===_.ACK)return void(this._isTrickleTx(s)&&this._trans_handler.closeTransactionWithSuccess(s,this,t));if(l(t))return u(t)?(e=new Error(t.error.code+" "+t.error.reason),void this._trans_handler.closeTransactionWithError(s,this,e)):(this._isHangupTx(s)||this._isDetachTx(s)||this.handlePluginMessage(t)||v.verbose(b+` ${this.name} received response could not be handled by the plugin`),void this._trans_handler.closeTransactionWithSuccess(s,this,t))}switch(i){case _.EVENT.EVENT:this.handlePluginMessage(t)?this._trans_handler.closeTransactionWithSuccess(s,this,t):(v.warn(b+` ${this.name} received event could not be handled by the plugin`),r=new Error("unmanaged event"),this._trans_handler.closeTransactionWithError(s,this,r));break;case _.EVENT.TRICKLE:var{completed:r,sdpMid:n,sdpMLineIndex:a,candidate:o}=t.candidate;v.verbose(b+` ${this.name} candidate: "${o}"; mid: "${n}"`),r?this.addIceCandidate():this.addIceCandidate({candidate:o,sdpMid:n,sdpMLineIndex:a});break;case _.EVENT.DETACHED:this._signalDetach();break;case _.EVENT.HANGUP:{this.hangupPeerConnection();let e="unknown reason";void 0!==t.reason&&(e=t.reason),this._session._client.dispatch(w.WEBRTC_DOWN,{id:this.id,reason:e});break}case _.EVENT.WEBRTCUP:this._session._client.dispatch(w.WEBRTC_UP,{id:this.id});break;case _.EVENT.MEDIA:case _.EVENT.SLOWLINK:break;default:v.warn(b+` ${this.name} unexpected event `+JSON.stringify(t))}}_isTrickleTx(e){e=this._trans_handler.get(e);return!!e&&e.request===_.REQUEST.TRICKLE}_isHangupTx(e){e=this._trans_handler.get(e);return!!e&&e.request===_.REQUEST.HANGUP}_isDetachTx(e){e=this._trans_handler.get(e);return!!e&&e.request===_.REQUEST.DETACH_PLUGIN}_signalDetach(){this._state!==p.DETACHED&&(this._trans_handler.closeTransactionWithError(this,new Error("handle detached")),this._state=p.DETACHED)}_decorateRequest(e){e.transaction=e.transaction||s(),e.handle_id=e.handle_id||this.id}async sendRequest(s){var e;if("object"!=typeof s||!s)throw e=new Error("request must be an object"),v.error(b+` ${this.name} `+e.message),e;if(this._state===p.DETACHED)throw e=new Error(`send request invalid state "${this._state}"`),v.error(b+` ${this.name} `+e.message),e;return this._decorateRequest(s),new Promise((e,t)=>{this._trans_handler.createTransaction(s.transaction,this,s.janus,e,t),this._session.sendRequest(s).catch(e=>{this._trans_handler.closeTransactionWithError(s.transaction,this,e)})})}async sendPluginRequest(e,t){if("object"!=typeof e||!e)throw s=new Error("plugin request body must be an object"),v.error(b+` ${this.name} `+s.message),s;var s={janus:_.REQUEST.MESSAGE,body:e};t&&(s.jsep=t);try{return this.sendRequest(s)}catch(e){throw v.error(b+` ${this.name} error on send plugin request (${e.message})`),e}}handlePluginMessage(){return null}addIceCandidate(e){return null}hangupPeerConnection(){return null}}const S={MIC:"mic",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},T={CAMERA:"camera",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},x="[media_stream_factory]";function y(e){return"object"==typeof e.video&&e.video.source===T.SCREENCAST}class G{static createMediaStream(e){var t;return"object"!=typeof e||!e.audio&&!e.video?Promise.reject(new TypeError("Invalid constrains")):y(e)||"object"!=typeof e.audio||e.audio.source!==S.SCREENCAST?!y(e)||h()||o()?y(e)&&"object"==typeof e.audio&&e.audio.source!==S.SCREENCAST?Promise.reject(new TypeError("Cannot capture video from screen cast while capture audio from other source.")):e.audio||e.video?(t=Object.create({}),"object"==typeof e.audio&&e.audio.source===S.MIC?(t.audio=Object.create({}),null!==window.navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?t.audio.deviceId=e.audio.deviceId:t.audio.deviceId={exact:e.audio.deviceId}):e.audio.source===S.SCREENCAST?t.audio=!0:t.audio=e.audio,"object"==typeof e.video?(t.video=Object.create({}),"number"==typeof e.video.frameRate&&(t.video.frameRate=e.video.frameRate),e.video.width&&e.video.height&&(e.video.source===T.SCREENCAST?(t.video.width=e.video.width,t.video.height=e.video.height):(t.video.width=Object.create({}),t.video.width.exact=e.video.width,t.video.height=Object.create({}),t.video.height.exact=e.video.height)),"string"==typeof e.video.deviceId&&(t.video.deviceId={exact:e.video.deviceId}),o()&&e.video.source===T.SCREENCAST&&(t.video.mediaSource="screen")):t.video=e.video,y(e)?navigator.mediaDevices.getDisplayMedia(t):navigator.mediaDevices.getUserMedia(t)):Promise.reject(new TypeError("At least one of audio and video must be requested.")):Promise.reject(new TypeError("Screen sharing only supports Chrome and Firefox.")):Promise.reject(new TypeError("Cannot share screen without video."))}}const C="[handle-pub]",D={REQUEST:{EXISTS:"exists",CREATE:"create",DESTROY:"destroy",JOIN:"join",CONFIGURE:"configure",UNPUBLISH:"unpublish"},FEEDBACK:{EXISTS:"room_exists",CREATED:"room_created",DESTROYED:"room_destroyed",JOINED:"room_joined",CONFIGURED:"room_configured",UNPUBLISHED:"unpublished",PUBLISHERS_LISTED:"room_publishers",PUBLISHER_LEAVING:"room_pub_leaving",ERROR:"room_error"}};class F extends B{constructor(e,t){super(e,t),this._local_steam=null,this._pc=null,this._pc_state=f.NEW,this.feed=null,this.on(D.FEEDBACK.UNPUBLISHED,({feed:e})=>{e===this.feed?v.warn(C+` ${this.name} unpub own feed shall never reach here`):this._session&&this._session.unpublished(e)}),this.on(D.FEEDBACK.PUBLISHERS_LISTED,({publishers:e})=>{0<e.length&&this._session&&this._session._room&&this._session._room.appendPublishers(e)}),this.on(D.FEEDBACK.PUBLISHER_LEAVING,({feed:e})=>{this._session&&this._session.unpublished(e),v.info(C+` ${this.name} ${e} is leaving`)}),v.info(C+" created pub handler "+this.name)}async openLocalMediaStream(e){var t;if(this._local_steam)throw t=new Error("local stream already added?"),v.error(C+` ${this.name} `+t.message),t;this._local_steam=await G.createMediaStream(e),this._session._client.dispatch(w.MEDIA_LOCAL_STREAM,this._local_steam)}closeLocalMediaStream(){this._local_steam?this._pc&&this.feed?v.warn(C+` ${this.name} closeLocalMediaStream() cannot close stream in publishing`):(this._local_steam.getTracks().forEach(e=>{e.stop()}),this._local_steam=null,this._session._client.dispatch(w.MEDIA_LOCAL_STREAM,this._local_steam)):v.warn(C+` ${this.name} closeLocalMediaStream() no stream to close`)}async publishLocalStream(){if(!this._local_steam)throw e=new Error("local stream not found to publish"),v.error(C+` ${this.name} `+e.message),e;this._initPeerConnection();var e=await this.createOffer(),e=(await this.setLocalDescription(e),await this.configure({audio:this._session._client._config.getNetworkAudioSend(),video:this._session._client._config.getNetworkVideoSend(),jsep:{type:"offer",sdp:e.sdp}}));await this.setRemoteDescription(e.jsep)}async unpublishLocalStream(){this.feed?this._pc_state!==f.CONNECTED?v.warn(C+` ${this.name} unpublishLocalStream() not published yet`):((await this.unpublish()).feed!==this.feed&&v.warn(C+` ${this.name} unpublishLocalStream() unpublished a wrong feed?`),this.feed=null):v.warn(C+` ${this.name} unpublishLocalStream() no publisher found`)}hangupPeerConnection(){this._pc&&(this._pc.getTransceivers().forEach(e=>{e.stop()}),this._pc.close(),this._pc_state=f.NEW,this._pc=null)}_initPeerConnection(){if(!this._pc){if(this._pc_state!==f.NEW)throw e=new Error("init Peer Connection invalid state "+this._pc_state),v.error(C+` ${this.name} `+e.message),e;var e={iceServers:this._session._client._config.getIceServers()};h()&&(e.sdpSemantics="unified-plan"),this._pc=new RTCPeerConnection(e),this._pc.onicecandidate=this._onIceCandidate.bind(this),this._pc.onicecandidateerror=this._onIceCandidateError.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.ontrack=this._onTrack.bind(this)}}async createOffer(){if(this._local_steam){if(this._pc){let e=null;this._session._client._config.getNetworkAudioSend()&&0<this._local_steam.getAudioTracks().length&&(e=this._pc.addTransceiver(this._local_steam.getAudioTracks()[0],{direction:"sendonly",sendEncodings:[]}));let t=null;var s={direction:"sendonly",sendEncodings:[]};return 0<this._local_steam.getVideoTracks().length&&this._session._client._config.getVideoEncodeSimulcast()&&(s.sendEncodings=[{rid:"h",active:!0,maxBitrate:1e6},{rid:"m",active:!0,maxBitrate:5e5,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:2e5,scaleResolutionDownBy:4}]),this._session._client._config.getNetworkVideoSend()&&0<this._local_steam.getVideoTracks().length&&(t=this._pc.addTransceiver(this._local_steam.getVideoTracks()[0],s)),e||t?this._pc.createOffer():void 0}v.warn(C+` ${this.name} create offer but no pc`)}else v.warn(C+` ${this.name} create offer but no local stream`)}async setLocalDescription(e){return this._pc.setLocalDescription(e)}async setRemoteDescription(e){return this._pc.setRemoteDescription(e)}addIceCandidate(e){this._pc.addIceCandidate(e)}_onIceCandidate(e){e.candidate?(v.verbose(C+` ${this.name} collected ice candidate: `+e.candidate.candidate),this.trickle(e.candidate)):this.trickle()}_onIceCandidateError(e){v.warn(C+` ${this.name} ice candidate error: ${e.url} 
        ${e.errorCode} `+e.errorText)}_onConnectionStateChange(e){switch(v.verbose(C+` ${this.name} peer connection state changed to: `+this._pc.connectionState),this._pc.connectionState){case"new":this._pc_state=f.NEW;break;case"connecting":this._pc_state=f.CONNECTING;break;case"connected":this._pc_state=f.CONNECTED;break;case"disconnected":case"closed":case"failed":this._pc_state=f.DISCONNECTED}}_onTrack(e){v.warn(C+` ${this.name} pub shall be send only`)}handlePluginMessage(e){var{plugindata:t,jsep:s,transaction:i}=e;if(t&&t.data&&t.data.videoroom){var r=t.data,{videoroom:t,error:n,error_code:a,room:o}=r,h={event:null,data:{}},s=(s&&(h.data.jsep=s),o&&(h.data.room=o),this._trans_handler.getTransactionOwner(i)!==this);switch(e._feedback=h,t){case"success":void 0!==r.exists&&(h.event=D.FEEDBACK.EXISTS,h.data.exists=r.exists);break;case"created":h.event=D.FEEDBACK.CREATED,h.data.room_permanent=r.permanent;break;case"destroyed":h.event=D.FEEDBACK.DESTROYED;break;case"joined":this.feed=r.id,h.event=D.FEEDBACK.JOINED,h.data.feed=r.id,h.data.description=r.description,h.data.publishers=r.publishers.map(({id:e,display:t,streams:s})=>{e={feed:e,display:t};return e.streams=s.map(({type:e,mid:t,talking:s,simulcast:i})=>({type:e,mid:t,talking:s,simulcast:i})),e});break;case"event":n?(h.event=D.FEEDBACK.ERROR,h.data=new Error(a+" "+n),h.data._code=a,this._trans_handler.closeTransactionWithError(i,this,h.data)):void 0!==r.publishers?(h.event=D.FEEDBACK.PUBLISHERS_LISTED,h.data.publishers=r.publishers.map(({id:e,display:t,streams:s})=>{e={feed:e,display:t};return e.streams=s.map(({type:e,mid:t,talking:s,simulcast:i})=>({type:e,mid:t,talking:s,simulcast:i})),e})):void 0!==r.configured?(h.event=D.FEEDBACK.CONFIGURED,h.data.feed=this.feed,h.data.configured=r.configured):void 0!==r.unpublished?(h.event=D.FEEDBACK.UNPUBLISHED,h.data.feed="ok"===r.unpublished?this.feed:r.unpublished):void 0!==r.leaving&&(h.event=D.FEEDBACK.PUBLISHER_LEAVING,h.data.feed="ok"===r.leaving?this.feed:r.leaving,r.reason)&&(h.data.reason=r.reason)}return h.event?(this._trans_handler.closeTransactionWithSuccess(i,this,e),s&&this.dispatch(h.event,h.data),h):(v.warn(C+` ${this.name} no feedback obtained?`),null)}return null}async exists(e){if("number"!=typeof e||!e){const i=new Error("exists() room id must be a valid number");throw v.error(C+` ${this.name} `+i.message),i}var e={request:D.REQUEST.EXISTS,room:e},{event:t,data:s}=(await this.sendPluginRequest(e))._feedback||{};if(t===D.FEEDBACK.EXISTS)return s;const i=new Error(`unexpected response to request "${e.request}"`);throw v.error(C+` ${this.name} `+i.message),i}async create(e,t,s,i,r,n,a,o,h,c,d,_,l,u,m,E,p,f,g){var w={request:D.REQUEST.CREATE},e=("number"==typeof e&&(w.room=e),"string"==typeof t&&(w.description=t),"number"==typeof s&&(w.publishers=s),"boolean"==typeof i&&(w.permanent=i),"boolean"==typeof r&&(w.is_private=r),"string"==typeof n&&(w.secret=n),"string"==typeof a&&(w.pin=a),"number"==typeof o&&(w.bitrate=o),"boolean"==typeof h&&(w.bitrate_cap=h),"number"==typeof c&&(w.fir_freq=c),"string"==typeof d&&(w.audiocodec=d),"string"==typeof _&&(w.videocodec=_),"boolean"==typeof l&&(w.audiolevel_event=l),"number"==typeof u&&0<=u&&u<=127&&(w.audio_level_average=u),"number"==typeof m&&0<m&&(w.audio_active_packets=m),"boolean"==typeof E&&(w.record=E),"string"==typeof p&&(w.rec_dir=p),"boolean"==typeof f&&(w.videoorient_ext=f),"string"==typeof g&&(w.h264_profile=g),await this.sendPluginRequest(w)),{event:t,data:s}=e._feedback||{};if(t===D.FEEDBACK.CREATED)return s;i=new Error(`unexpected response to request "${w.request}"`);throw v.error(C+` ${this.name} `+i.message),i}async destroy(e,t,s){e={request:D.REQUEST.DESTROY,room:e},"boolean"==typeof t&&(e.permanent=t),"string"==typeof s&&(e.secret=s),t=await this.sendPluginRequest(e),s=(t._feedback||{}).event;if(s===D.FEEDBACK.DESTROYED)return{};t=new Error(`unexpected response to request "${e.request}"`);throw v.error(C+` ${this.name} `+t.message),t}async join(e,t,s){var e={request:D.REQUEST.JOIN,ptype:E.PUB,room:e},t=("string"==typeof t&&(e.display=t),"string"==typeof s&&(e.token=s),await this.sendPluginRequest(e)),{event:s,data:t}=t._feedback||{};if(s===D.FEEDBACK.JOINED)return t;s=new Error(`unexpected response to request "${e.request}"`);throw v.error(C+` ${this.name} `+s.message),s}async configure({audio:e,video:t,data:s,bitrate:i,record:r,filename:n,display:a,restart:o,update:h,sc_substream_layer:c,sc_substream_fallback_ms:d,sc_temporal_layers:_,jsep:l}){var u={request:D.REQUEST.CONFIGURE},e=("boolean"==typeof e&&(u.audio=e),"boolean"==typeof t&&(u.video=t),"boolean"==typeof s&&(u.data=s),"number"==typeof i&&(u.bitrate=i),"boolean"==typeof r&&(u.record=r),"string"==typeof n&&(u.filename=n),"string"==typeof a&&(u.display=a),"boolean"==typeof o&&(u.restart=o),"boolean"==typeof h&&(u.update=h),"number"==typeof c&&(u.substream=c),"number"==typeof d&&(u.fallback=1e3*d),"number"==typeof _&&(u.temporal=_),await this.sendPluginRequest(u,l).catch(e=>{throw l&&e._code&&429<=e._code&&e._code<=437&&434!=e._code&&this.hangup().catch(()=>{}),e})),{event:t,data:s}=e._feedback||{};if(t===D.FEEDBACK.CONFIGURED&&"ok"===s.configured)return u.display&&(s.display=u.display),"boolean"==typeof u.restart&&(s.restart=u.restart),"boolean"==typeof u.update&&(s.update=u.update),s;i=new Error(`unexpected response to request "${u.request}"`);throw v.error(C+` ${this.name} `+i.message),i}async unpublish(){var e={request:D.REQUEST.UNPUBLISH},{event:t,data:s}=(await this.sendPluginRequest(e))._feedback||{};if(t===D.FEEDBACK.UNPUBLISHED)return s;t=new Error(`unexpected response to request "${e.request}"`);throw v.error(C+` ${this.name} `+t.message),t}}class R{constructor(e,t){this._session=e,this.id=t,this.name=`[${this.id}]`,this._state=g.EXISTED,this._description=null,this._available_feeds=[],this._attendees=null}addPublishers(e){this._available_feeds=e,this._session._client.dispatch(w.MEDIA_REMOTE_FEEDS_ADDED,e)}appendPublishers(e){this._available_feeds.push(...e),this._session._client.dispatch(w.MEDIA_REMOTE_FEEDS_ADDED,e)}async delPublisher(t){this._feedInList(t)&&(this._available_feeds=this._available_feeds.filter(e=>e.feed!==t),this._session._client.dispatch(w.MEDIA_REMOTE_STREAM,{feed:t,stream:null}),0===this._available_feeds.length)&&await this._session.detachHandle(E.SUB)}_feedInList(t){var e=this._available_feeds.filter(e=>e.feed===t);return!!(e&&0<e.length)}static feedsToStreams(e){const s=[];return e.forEach(t=>{t.streams.forEach(e=>{s.push({feed:t.feed,mid:e.mid})})}),s}}const $="[handle-pub]",A={REQUEST:{JOIN:"join",START:"start",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",CONFIGURE:"configure"},FEEDBACK:{ATTACHED:"room_attached",STARTED:"room_started",UPDATED:"room_updated",CONFIGURED:"room_configured",UPDATING:"room_sub_updating",ERROR:"room_error"}};class H extends B{constructor(e,t){super(e,t),this._streams=[],this._pc=null,this._pc_state=f.NEW,this.on(A.FEEDBACK.UPDATED,({streams:e,jsep:t})=>{this._handleStreamsUpdate(e,t)}),v.info($+" created sub handler "+this.name)}async joinAndSubscribe(e){this._initPeerConnection();var e=await this.join(this._session._room.id,e),e=(this._updateRemoteStreams(e.streams),await this.setRemoteDescription(e.jsep),await this._pc.createAnswer()),t={type:e.type,sdp:e.sdp};await this.setLocalDescription(e),await this.start(t),v.info($+` ${this.name} join and subscribe done`)}async subscribeRemoteFeeds(e){var t;this._pc?(e=await this.subscribe(e),this._updateRemoteStreams(e.streams),await this.setRemoteDescription(e.jsep),t={type:(e=await this._pc.createAnswer()).type,sdp:e.sdp},await this.setLocalDescription(e),await this.start(t),v.info($+` ${this.name} subscribe streams done`)):v.warn($+` ${this.name} subscribe remote feeds but pc is not ready`)}async _handleStreamsUpdate(e,t){this._anyActiveStream(e)?this._pc?(this._updateRemoteStreams(e),await this.setRemoteDescription(t),t={type:(e=await this._pc.createAnswer()).type,sdp:e.sdp},await this.setLocalDescription(e),await this.start(t),v.info($+` ${this.name} update remote streams done`)):v.warn($+` ${this.name} handle updated remote feeds but pc is not ready`):v.verbose($+` ${this.name} no active remote streams, pending for detach`)}hangupPeerConnection(){this._pc&&(this._pc.getTransceivers().forEach(e=>{e.stop()}),this._pc.close(),this._pc_state=f.NEW,this._pc=null)}_initPeerConnection(){if(!this._pc){if(this._pc_state!==f.NEW)throw e=new Error("init Peer Connection invalid state "+this._pc_state),v.error($+` ${this.name} `+e.message),e;var e={iceServers:this._session._client._config.getIceServers()};h()&&(e.sdpSemantics="unified-plan"),this._pc=new RTCPeerConnection(e),this._pc.onicecandidate=this._onIceCandidate.bind(this),this._pc.onicecandidateerror=this._onIceCandidateError.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.ontrack=this._onTrack.bind(this)}}async setLocalDescription(e){return this._pc.setLocalDescription(e)}async setRemoteDescription(e){return this._pc.setRemoteDescription(e)}addIceCandidate(e){this._pc.addIceCandidate(e)}_onIceCandidate(e){e.candidate?(v.verbose($+` ${this.name} collected ice candidate: `+e.candidate.candidate),this.trickle(e.candidate)):this.trickle()}_onIceCandidateError(e){v.warn($+` ${this.name} ice candidate error: ${e.url} 
        ${e.errorCode} `+e.errorText)}_onConnectionStateChange(e){switch(v.verbose($+` ${this.name} peer connection state changed to: `+this._pc.connectionState),this._pc.connectionState){case"new":this._pc_state=f.NEW;break;case"connecting":this._pc_state=f.CONNECTING;break;case"connected":this._pc_state=f.CONNECTED;break;case"disconnected":case"closed":case"failed":this._pc_state=f.DISCONNECTED}}_onTrack(e){var t;v.info($+` ${this.name} incoming remote track`),"video"===e.track.kind&&e.streams&&0<e.streams.length&&(t=this._getFeedFromMid(e.transceiver.mid),this._session._client.dispatch(w.MEDIA_REMOTE_STREAM,{feed:t,stream:e.streams[0]}))}_updateRemoteStreams(e){this._streams=e}_anyActiveStream(e){e=e.filter(e=>!0===e.active);return!!(e&&0<e.length)}_getFeedFromMid(t){var e=this._streams.filter(e=>e.mid===t);if(e&&0<e.length)return e[0].feed_id}handlePluginMessage(e){var{plugindata:t,jsep:s,transaction:i}=e;if(t&&t.data&&t.data.videoroom){var r=t.data,{videoroom:t,error:n,error_code:a,room:o}=r,h={event:null,data:{}},s=(s&&(h.data.jsep=s),o&&(h.data.room=o),this._trans_handler.getTransactionOwner(i)!==this);switch(e._feedback=h,t){case"attached":h.event=A.FEEDBACK.ATTACHED,h.data.streams=r.streams;break;case"updated":h.event=A.FEEDBACK.UPDATED,h.data.streams=r.streams;break;case"updating":h.event=A.FEEDBACK.UPDATING;break;case"event":n?(h.event=A.FEEDBACK.ERROR,h.data=new Error(a+" "+n),h.data._code=a,this._trans_handler.closeTransactionWithError(i,this,h.data)):void 0!==r.started&&(h.event=A.FEEDBACK.STARTED,h.data.started=r.started)}return h.event?(this._trans_handler.closeTransactionWithSuccess(i,this,e),s&&this.dispatch(h.event,h.data),h):(v.warn($+` ${this.name} no feedback obtained?`),null)}return null}async join(e,t){var e={request:A.REQUEST.JOIN,ptype:E.SUB,room:e},t=(t&&(e.streams=R.feedsToStreams(t)),await this.sendPluginRequest(e)),{event:t,data:s}=t._feedback||{};if(t===A.FEEDBACK.ATTACHED)return s;t=new Error(`unexpected response to request "${e.request}"`);throw v.error($+` ${this.name} `+t.message),t}async start(e){var t={request:A.REQUEST.START},{event:e,data:s}=(await this.sendPluginRequest(t,e))._feedback||{};if(e===A.FEEDBACK.STARTED)return s;e=new Error(`unexpected response to request "${t.request}"`);throw v.error($+` ${this.name} `+e.message),e}async subscribe(e){var t={request:A.REQUEST.SUBSCRIBE},e=(e&&(t.streams=R.feedsToStreams(e)),await this.sendPluginRequest(t)),{event:e,data:s}=e._feedback||{};if(e===A.FEEDBACK.UPDATED||e===A.FEEDBACK.UPDATING)return s;e=new Error(`unexpected response to request "${t.request}"`);throw v.error($+` ${this.name} `+e.message),e}}const N="[session]",W="janus.plugin.videoroom";class K{constructor(e,t,s=30){this.id=t,this.name=`[${this.id}]`,this._client=e,this._trans_handler=e._trans_handler,this._sess_state=m.CREATED,this._pub_handle=null,this._sub_handle=null,this._room=null,this._ka_task=null,this._setKeepAlive(1e3*s)}async attachHandler(e){v.info(N+` ${this.name} attach handle `+W);var t={janus:_.REQUEST.ATTACH_PLUGIN,plugin:W};try{var{id:s}=(await this.sendRequest(t))["data"];e===E.PUB?this._pub_handle=new F(this,s):e===E.SUB?this._sub_handle=new H(this,s):v.warn(N+` ${this.name} attaching invalid handle type `+e),v.info(N+` ${this.name} handle attached (id = ${s})`)}catch(e){throw v.error(N+` ${this.name} handle attach error (${e.message})`),e}}async detachHandle(e){e===E.PUB&&this._pub_handle?(await this._pub_handle.detach(),this._pub_handle._state=p.DETACHED,this._pub_handle=null):e===E.SUB&&this._sub_handle&&(await this._sub_handle.detach(),this._sub_handle._state=p.DETACHED,this._sub_handle=null)}async detachHandlers(){v.info(N+` ${this.name} detach all handlers`),this._pub_handle&&(await this._pub_handle.detach(),this._pub_handle._state=p.DETACHED,this._pub_handle=null),this._sub_handle&&(await this._sub_handle.detach(),this._sub_handle._state=p.DETACHED,this._sub_handle=null)}async destroy(){if(v.info(N+` ${this.name} destroying session`),this._sess_state!==m.CREATED)throw e=new Error(`destroy session invalid state "${this._sess_state}"`),v.warn(N+` ${this.name} `+e.message),e;this._sess_state=m.DESTROYING;var e={janus:_.REQUEST.DESTROY_SESSION};try{await this.sendRequest(e)}catch(e){throw v.error(N+` ${this.name} error while destroying session (${e.message})`),e}}async roomExists(e){if(this._pub_handle)return!!(e=await this._pub_handle.exists(e))&&e.exists;throw e=new Error("create room without valid plugin handle"),v.error(N+` ${this.name} `+e.message),e}async attachRoom(e){var t;if(!this._pub_handle)throw t=new Error("create room without valid plugin handle"),v.error(N+` ${this.name} `+t.message),t;this._room=new R(this,e)}async createRoom(e,t,s,i,r,n,a,o,h,c,d,_,l,u,m,E,p,f,g){if(!this._pub_handle)throw w=new Error("create room without valid plugin handle"),v.error(N+` ${this.name} `+w.message),w;var w=await this._pub_handle.create(e,t,s,i,r,n,a,o,h,c,d,_,l,u,m,E,p,f,g);v.info(N+` ${this.name} room ${e} created, permanent: `+w.room_permanent),this._room=new R(this,e)}async destroyRoom(e,t){var s;if(!this._pub_handle)throw s=new Error("create room without valid plugin handle"),v.error(N+` ${this.name} `+s.message),s;if(!this._room)throw s=new Error("no room instance to destroy"),v.error(N+` ${this.name} `+s.message),s;await this._pub_handle.destroy(this._room.id,e,t),v.info(N+` ${this.name} room ${this._room.id} destroyed`),this._room=null}async joinRoom(e){if(!this._room)throw t=new Error("no room instance to join"),v.error(N+` ${this.name} `+t.message),t;this._room._state=g.JOINING;var t=await this._pub_handle.join(this._room.id,e);this._room._state=g.JOINED,this._room._description=t.description,0<t.publishers.length&&this._room.addPublishers(t.publishers)}async subscribeFeeds(e){this._sub_handle?await this._sub_handle.subscribeRemoteFeeds(e):(await this.attachHandler(E.SUB),await this._sub_handle.joinAndSubscribe(e))}unpublished(e){this._room&&this._room.delPublisher(e)}_handleMessage(t){var{sender:s,janus:i,transaction:r}=t;if(s){let e=null;return(this._pub_handle&&s===this._pub_handle.id?e=this._pub_handle:this._sub_handle&&s===this._sub_handle.id&&(e=this._sub_handle),e)?void e._handleMessage(t):i===_.EVENT.DETACHED?void 0:void v.verbose(N+` ${this.name} handle ${s} not found for incoming message "${i}"`)}if(r){var s=this._trans_handler.getTransactionOwner(r);if(!s)return;let e=null;if(this._pub_handle&&s.id===this._pub_handle.id?e=this._pub_handle:this._sub_handle&&s.id===this._sub_handle.id&&(e=this._sub_handle),e&&e===s)return void e._handleMessage(t)}if(r){if(v.verbose(N+` ${this.name} received "${i}" for transaction `+r),this._trans_handler.getTransactionOwner(r)!==this)v.warn(N+` ${this.name} transaction ${r} not found for incoming message "${i}"`);else if(l(t)||this._isKeepaliveTx(r)){if(u(t))return s=new Error(t.error.code+" "+t.error.reason),void this._trans_handler.closeTransactionWithError(r,this,s);this._trans_handler.closeTransactionWithSuccess(r,this,t)}}else"object"==typeof(i=t)&&i&&i.janus===_.EVENT.TIMEOUT?(v.warn(N+` ${this.name} session timed out by Janus server.`),this._signalDestroy()):v.error(N+` ${this.name} unexpected janus message directed to the session "${JSON.stringify(t)}"`)}_signalDestroy(){this._sess_state!==m.DESTROYED&&(this._unsetKeepAlive(),this._trans_handler.closeAllTransactionsWithError(this,new Error("session destroyed")),this._pub_handle&&(this._pub_handle._signalDetach(),this._pub_handle=null),this._sub_handle&&(this._sub_handle._signalDetach(),this._sub_handle=null),this._sess_state=m.DESTROYED)}async _sendKeepAlive(s){var e={janus:_.REQUEST.KEEPALIVE};let i;var t=new Promise((e,t)=>{i=setTimeout(e=>t(new Error("timeout")),s)}),e=(v.verbose(N+` ${this.name} sending keep-alive (timeout = ${s}ms)`),this.sendRequest(e).then(e=>{v.verbose(N+` ${this.name} keep-alive OK`),clearTimeout(i)}).catch(e=>{throw v.error(N+` ${this.name} keep-alive error (${e.message})`),clearTimeout(i),e}));return Promise.race([e,t])}_setKeepAlive(e){if(!this._ka_task){const t=e/2;this._ka_task=setInterval(e=>{this._sendKeepAlive(t).catch(({message:e})=>{this._sess_state!==m.DESTROYED&&(e=new Error(`keep-alive failed (${e})`),v.error(N+` ${this.name} `+e.message)),this._signalDestroy()})},e),v.info(N+` ${this.name} session keep-alive task scheduled every ${e} milliseconds`)}}_unsetKeepAlive(){this._ka_task&&(clearInterval(this._ka_task),this._ka_task=null,v.info(N+` ${this.name} session keep-alive task disabled`))}_isKeepaliveTx(e){e=this._trans_handler.get(e);return!!e&&e.request===_.REQUEST.KEEPALIVE}_decorateRequest(e){e.transaction=e.transaction||s(),e.session_id=e.session_id||this.id}async sendRequest(s){var e;if("object"!=typeof s||!s)throw e=new Error("request must be an object"),v.error(N+` ${this.name} `+e.message),e;if(this._sess_state===m.DESTROYED)throw e=new Error("invalid session state "+this._sess_state),v.error(N+` ${this.name} `+e.message),e;return this._decorateRequest(s),new Promise((e,t)=>{this._trans_handler.createTransaction(s.transaction,this,s.janus,e,t),this._client.sendRequest(s).catch(e=>{this._trans_handler.closeTransactionWithError(s.transaction,this,e)})})}}const I="[trans_mqtt]",O={NEW:"new",OPENING:"opening",OPENED:"opened",CLOSING:"closing",CLOSED:"closed"};class V{constructor(e){this._client=e,this._mqtt_client=null,this._attempt=0,this._state=O.NEW,this.id=e.id,this.name=`[${this.id}]`}async _initMQTT(){return v.info(I+` ${this.name} init mqtt connection with `+this._client._config.getServer().url),new Promise((t,s)=>{const e=j.default.connect(this._client._config.getServer().url);e.on("connect",()=>{this._state=O.OPENED,e.subscribe(`from-${this._client._config.getServer().name}/`+this._client._session_id,e=>{e?s("subscribe failed"):t(this)})}),e.on("message",(e,t)=>{v.debug(I+` ${this.name} <mqtt RCV OK> `+t),this._client._handleMessage(JSON.parse(t))}),e.on("close",()=>{v.info(I+` ${this.name} closed`),this._client._signalClosed(this._state===O.CLOSING),this._state=O.CLOSED,t(this)}),e.on("reconnect",()=>{v.info(I+` ${this.name} reconnecting...`)}),e.on("error",e=>{v.error(I+` ${this.name} error (${e})`),s(e)}),this._mqtt_client=e})}async _attemptOpen(){this._state=O.OPENING;try{return await this._initMQTT()}catch(e){var t;if(this._attempts++,this._attempts>=this._client._config.getServer().max_retries)throw this._state=O.NEW,t=new Error("attempt limit exceeded"),v.error(I+` ${this.name} connection failed, `+t.message),e;return v.warn(I+` ${this.name} connection failed, will try again in 
            ${this._client._config.getServer().retry_time_second} seconds...`),await n(1e3*this._client._config.getServer().retry_time_second),this._attemptOpen()}}async open(){var e;if(this._state!==O.NEW)throw e=new Error("open mqtt with invalid state "+this._state),v.error(I+` ${this.name} `+e.message),e;return this._attempts=0,this._attemptOpen()}async close(){var e;if(this._state!==O.OPENED)throw e=new Error("close mqtt with invalid state "+this._state),v.error(I+` ${this.name} `+e.message),e;return this._state=O.CLOSING,new Promise((e,t)=>{v.info(I+` ${this.name} closing`);try{this._mqtt_client.end()}catch(e){v.error(I+` ${this.name} error while closing (${e.message})`),t(e)}})}async send(e){var t;if(this._state!==O.OPENED)throw t=new Error("send mqtt request with invalid state "+this._state),v.error(I+` ${this.name} `+t.message),t;const i=JSON.stringify(e);return new Promise((t,s)=>{this._mqtt_client.publish("to-"+this._client._config.getServer().name,i,{qos:0,retain:!1},e=>{e?(v.error(I+` ${this.name} mqtt send error `+e.message),s(e)):(v.debug(I+` ${this.name} <mqtt SND OK> `+i),t())})})}}const k="[trans_ws]",P={NEW:"new",OPENING:"opening",OPENED:"opened",CLOSING:"closing",CLOSED:"closed"};class Q{constructor(e){this._client=e,this._ws=null,this._attempts=0,this._state=P.NEW,this.id=e.id,this.name=`[${this.id}]`}async _initWebSocket(){return v.info(k+` ${this.name} init ws connection with `+this._client._config.getServer().url),new Promise((i,t)=>{var e=new WebSocket(this._client._config.getServer().url,["janus-protocol"],{handshakeTimeout:5e3});e.addEventListener("open",e=>{v.info(k+` ${this.name} websocket opened (${e})`),this._state=P.OPENED,i(this)},{once:!0}),e.addEventListener("close",({code:e,reason:t,wasClean:s})=>{v.info(k+` ${this.name} websocket closed code = 
               ${e}, reason = ${t}, clean = `+s),this._client._signalClosed(this._state===P.CLOSING),this._state=P.CLOSED,"function"===this._ws.removeAllListeners&&this._ws.removeAllListeners(),i(this)},{once:!0}),e.addEventListener("error",e=>{v.error(k+` ${this.name} websocket error (${e})`),t(e)},{once:!0}),e.addEventListener("message",({data:e})=>{v.debug(k+` ${this.name} <ws RCV OK> `+e),this._client._handleMessage(JSON.parse(e))}),this._ws=e})}async _attemptOpen(){this._state=P.OPENING;try{return await this._initWebSocket()}catch(e){var t;if(this._attempts++,this._attempts>=this._client._config.getServer().max_retries)throw this._state=P.NEW,t=new Error("attempt limit exceeded"),v.error(k+` ${this.name} connection failed, `+t.message),e;return v.warn(k+` ${this.name} connection failed, will try again in 
            ${this._client._config.getServer().retry_time_second} seconds...`),await n(1e3*this._client._config.getServer().retry_time_second),this._attemptOpen()}}async open(){var e;if(this._state!==P.NEW)throw e=new Error("open ws with invalid state "+this._state),v.error(k+` ${this.name} `+e.message),e;return this._attempts=0,this._attemptOpen()}async close(){var e;if(this._state!==P.OPENED)throw e=new Error("close ws with invalid state "+this._state),v.error(k+` ${this.name} `+e.message),e;return this._state=P.CLOSING,new Promise((e,t)=>{v.info(k+` ${this.name} closing ws`);try{this._ws.close()}catch(e){v.error(k+` ${this.name} error while closing websocket (${e.message})`),t(e)}})}async send(e){if(this._state!==P.OPENED)throw t=new Error("send ws request with invalid state "+this._state),v.error(k+` ${this.name} `+t.message),t;var t=JSON.stringify(e);return v.debug(k+` ${this.name} <ws SND OK> `+t),this._ws.send(t)}}const L="[tdg_client]";console.log("build date:","Mon Jan 16 2023 10:45:41 GMT+0800 (Singapore Standard Time)"),console.log("version:","1.0.0");var J=class extends q{constructor(t){super("tdg_client"),this.id=parseInt(c()),this.name=`[${this.id}]`,this._config=t,this._trans_handler=new M,this._transport=null;try{let e;(e=new(t.getServer().url.includes("mqtt")?V:Q)(this))&&(this._transport=e)}catch(e){v.error(L+` ${this.name} error while initializing transport (${e.message})`)}var e;this._session=null,this._session_id=(t=1e15,e=1e16,t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t)+t))}async openSession(){var e;if(v.verbose(L+` ${this.name} openSession() is called`),!(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection))throw this.dispatch(w.WEBRTC_NOT_SUPPORTED,"not supported"),e=new Error("WebRTC not supported by this browser"),v.error(L+` ${this.name} `+e.message),e;if(null!==this._session)throw e=new Error("init a session that already exists"),v.error(L+` ${this.name} `+e.message),e;if(null===this._transport)throw e=new Error("transport not found"),v.error(L+` ${this.name} `+e.message),e;await this._transport.open(),await this._createSession()}async joinRoom(e,t){var s;if("number"!=typeof e||!e)throw s=new Error("join room id must be a valid integer"),v.error(L+` ${this.name} `+s.message),s;if(!this._session)throw s=new Error("must open session before joining room"),v.error(L+` ${this.name} `+s.message),s;await this._session.attachHandler(E.PUB),await this._session.roomExists(e)?(v.info(L+` ${this.name} room exists: "true"`),this._session.attachRoom(e)):(v.info(L+` ${this.name} room exists: "false"`),await this._session.createRoom(e)),await this._session.joinRoom(t)}async openLocalMediaStream(e){if(this._session&&this._session._pub_handle)return this._session._pub_handle.openLocalMediaStream(e);v.warn(L+` ${this.name} openLocalMediaStream() pub handle not ready?`)}async publish(){if(this._session&&this._session._pub_handle)return this._session._pub_handle.publishLocalStream();v.warn(L+` ${this.name} publish() pub handle not ready?`)}async unpublish(){if(this._session&&this._session._pub_handle)return this._session._pub_handle.unpublishLocalStream();v.warn(L+` ${this.name} unpublish() pub handle not ready?`)}async closeLocalMediaStream(){if(this._session&&this._session._pub_handle)return this._session._pub_handle.closeLocalMediaStream();v.warn(L+` ${this.name} closeLocalMediaStream() pub handle not ready?`)}async subscribe(e){var t;if(!Array.isArray(e)||!e.length)throw t=new Error("subscribe must be a valid array"),v.error(L+` ${this.name} `+t.message),t;if(!this._session)throw t=new Error("must open session before subscribe"),v.error(L+` ${this.name} `+t.message),t;await this._session.subscribeFeeds(e)}async leaveRoom(){this._session&&await this._session.detachHandlers()}async closeSession(){this._session&&await this._session.destroy(),this._transport&&await this._transport.close()}async _createSession(e){v.info(L+` ${this.name} creating new session`);var t={janus:_.REQUEST.CREATE_SESSION,id:this._session_id};try{var{id:s}=(await this.sendRequest(t))["data"],i=new K(this,s,e);return this._session=i,v.info(L+` ${this.name} session created with id `+s),this.dispatch(w.SESSION_STATE_CHANGED,{id:s,state:m.CREATED}),i}catch(e){throw v.error(L+` ${this.name} session creation error `+e.message),e}}async sendRequest(s){return this._decorateRequest(s),new Promise((e,t)=>{this._trans_handler.createTransaction(s.transaction,this,s.janus,e,t),this._transport.send(s).catch(e=>{this._trans_handler.closeTransactionWithError(s.transaction,this,e)})})}_decorateRequest(e){e.transaction=e.transaction||s(),this._config.getServer().apisecret&&(e.apisecret=e.apisecret||this._config.getServer.apisecret),this._config.getServer().token&&(e.token=this._config.getServer().token)}_signalClosed(e){this._trans_handler.closeAllTransactionsWithError(null,new Error("sig transport disconnected")),this._trans_handler.clear();var t=this._session.id;this._session._signalDestroy(),this._session=null,e?this.dispatch(w.SESSION_STATE_CHANGED,{id:t,state:m.DESTROYED,reason:"graceful close"}):(e=new Error("unexpected sig transport disconnection"),this.dispatch(w.SESSION_STATE_CHANGED,{id:t,state:m.DESTROYED,reason:e.message})),this.offAll()}async _updateTransport(e){this._transport&&await this._transport.update(e)}_handleMessage(e){var t,{session_id:s,transaction:i,janus:r}=e;if(i&&l(e)&&"create"===this._trans_handler.get(i).request)return u(e)?(t=new Error(e.error.code+" "+e.error.reason),this._trans_handler.closeTransactionWithError(i,this,t)):void this._trans_handler.closeTransactionWithSuccess(i,this,e);if(s)if(s!==this._session.id)v.warn(L+` ${this.name} session ${s} not found for incoming message `+r);else try{this._session._handleMessage(e)}catch(e){v.error(L+` ${this.name} error while handling message (${e.message})`)}else if(i){if(v.verbose(L+` ${this.name} received ${r} for transaction `+i),this._trans_handler.getTransactionOwner(i)!==this)v.warn(L+` ${this.name} transaction ${i} not found for incoming message `+r);else if(l(e)){if(u(e))return t=new Error(e.error.code+" "+e.error.reason),this._trans_handler.closeTransactionWithError(i,this,t);this._trans_handler.closeTransactionWithSuccess(i,this,e)}}else v.error(L+` ${this.name} received an unexpected janus message `+JSON.stringify(e))}},Y=w,X=class{constructor({server:e,iceServers:t,network:s,video_encode:i}){if(!e)throw new Error('invalid configuration, missing parameter "server"');if("object"!=typeof e)throw new Error('invalid configuration, "server" must be an object');if("string"!=typeof e.url||!e.url)throw new Error("invalid configuration, missing server url attribute");if(this._server={},this._server.url=e.url||"",this._server.retry_time_second=e.retry_time_second&&"number"==typeof e.retry_time_second?e.retry_time_second:10,this._server.max_retries=e.max_retries&&"number"==typeof e.max_retries?e.max_retries:5,e.name&&"string"==typeof e.name&&(this._server.name=e.name),!t)throw new Error('invalid configuration, missing parameter "iceServers"');if(Array.isArray(t)&&0===t.length)throw new Error('invalid configuration, empty parameter "iceServers');this._ice_servers=Array.isArray(t)?t:[t];for(const r of this._ice_servers){if(!r||"object"!=typeof r)throw new Error("invalid configuration, element of iceServers must be an object");if(!r.urls)throw new Error("invalid configuration, missing ice server urls attribute");if("string"==typeof r.urls){if(!a(r.urls,["stun","turn"]))throw new Error("invalid configuration, ice server only works with either stun or turn")}else{if(!Array.isArray(r.urls))throw new Error("invalid configuration, ice server urls must be either string or array");for(const n of r.urls)if(!a(n,["stun","turn"]))throw new Error("invalid configuration, ice server only works with either stun or turn")}}if(!s)throw new Error('invalid configuration, missing parameter "network"');if("object"!=typeof s)throw new Error('invalid configuration, "network" must be an object');this._network_audio_send=!s.audio_send||"boolean"!=typeof s.audio_send||s.audio_send,this._network_audio_recv=!s.audio_recv||"boolean"!=typeof s.audio_recv||s.audio_recv,this._network_video_send=!s.video_send||"boolean"!=typeof s.video_send||s.video_send,this._network_video_recv=!s.video_recv||"boolean"!=typeof s.video_recv||s.video_recv,this._video_encode_simulcast=!(!i.simulcast||"boolean"!=typeof i.simulcast)&&i.simulcast}getServer(){return this._server}setServerUrl(e){this._server.url=e}getIceServers(){return this._ice_servers}getNetworkAudioSend(){return this._network_audio_send}getNetworkAudioRecv(){return this._network_audio_recv}getNetworkVideoSend(){return this._network_video_send}getNetworkVideoRecv(){return this._network_video_recv}getVideoEncodeSimulcast(){return this._video_encode_simulcast}setVideoEncodingSimulcast(e){this._video_encode_simulcast=e}},z=S,Z=T,ee=class{constructor(t,e,s,i){var r;if(!Object.values(T).some(e=>e===t))throw r=new Error("invalid video source: "+t),v.error(x+` ${this.name} `+r.message),r;this.source=t,this.width=e,this.height=s,this.frameRate=i,this.deviceId=void 0}},te=class{constructor(e=!1,t=!1){this.audio=e,this.video=t}};return e.AudioConstraints=class{constructor(t){var e;if(!Object.values(S).some(e=>e===t))throw e=new Error("invalid audio source: "+t),v.error(x+` ${this.name} `+e.message),e;this.source=t,this.deviceId=void 0}},e.AudioSource=z,e.Client=J,e.Configuration=X,e.Events=Y,e.MediaConstraints=te,e.VideoConstraints=ee,e.VideoSource=Z,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
